<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" /> 
		<title>WebSocket Test</title> 
		<script src="@routes.Assets.at("javascripts/gauge.min.js")" type="text/javascript"></script>
		<script src="@routes.Assets.at("javascripts/smoothie.js")" type="text/javascript"></script>
		<script language="javascript" type="text/javascript">
			var wsUri = "ws://192.168.0.14:9000/realtime";
			var output;
			var tds = {};
			var gauges = {};
			var charts = {};
			var gaugeOpts = {
				lines: 12, // The number of lines to draw
				 angle: 0.15, // The length of each line
				 lineWidth: 0.44, // The line thickness
			     pointer: {
				         length: 0.9, // The radius of the inner circle
								     strokeWidth: 0.035, // The rotation offset
								         color: '#000000' // Fill color
										   },
					       colorStart: '#11CF2A',   // Colors
							     colorStop: '#11CF2A',    // just experiment with them
							       strokeColor: '#E0E0E0',   // to see which ones work best for you
							         generateGradient: false
			};

			function init() {
				output = document.getElementById("output"); testWebSocket();
				//document.getElementById("message").addEventListener("submit", function(evt) {
				//	var title = document.getElementById("title")
				//	var content = document.getElementById("content")
				//	console.log(title.value, content.value)
				//	websocket.send(JSON.stringify({title: title.value, content: content.value}))
				//	evt.stopPropagation()
				//	evt.preventDefault()
				//})
			}
			function testWebSocket() {
				websocket = new WebSocket(wsUri);
				websocket.onopen = function(evt) { onOpen(evt) };
				websocket.onclose = function(evt) { onClose(evt) };
				websocket.onmessage = function(evt) { onMessage(evt) };
				websocket.onerror = function(evt) { onError(evt) };
			}
			function onOpen(evt) {
				/*writeToScreen("CONNECTED");*/
			}
			function onClose(evt) { /*writeToScreen("DISCONNECTED");*/ }
			function onMessage(evt) { writeToScreen(JSON.parse(evt.data)); }
			function onError(evt) { writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data); }
			function doSend(message) { writeToScreen("SENT: " + message);  websocket.send(message); }
			function writeToScreen(message) {

				if (message['address'] in tds) {
					var td = tds[message['address']];
					td.innerHTML = message['value'];
					gauges[message['address']].set(message['value']);
					charts[message['address']].append(new Date().getTime(), message['value']);
				} else if (message['address'] >= 50462) {

					var tr = document.createElement("tr");
					var th = document.createElement("th");
					var td = document.createElement("td");
					var canvas = document.createElement("canvas");
					canvas.width=100;
					canvas.height=100;
					var gauge = new Gauge(canvas).setOptions(gaugeOpts);
					gauge.maxValue = 15;
					gauge.minValue = 5;
					gauge.animationSpeed =32;
					gauge.set(message['value']);

					var chartCanvas = document.createElement("canvas");
					chartCanvas.width=400;
					chartCanvas.height=100;
					var chart = new SmoothieChart();
					chart.streamTo(chartCanvas);
					var chartLine = new TimeSeries();
					chart.addTimeSeries(chartLine);
					charts[message['address']] = chartLine;
					chartLine.append(new Date().getTime(), message['value']);

					tds[message['address']] = td;
					gauges[message['address']] = gauge;
					td.innerHTML = message['value'];
					th.innerHTML = message['address'];
					tr.insertBefore(chartCanvas, tr.firstChild);
					tr.insertBefore(canvas, tr.firstChild);
					//tr.insertBefore(td, tr.firstChild);
					tr.insertBefore(th, tr.firstChild);
					output.insertBefore(tr, output.firstChild);
				}

				//var pre = document.createElement("p");
				//pre.style.wordWrap = "break-word";
				//pre.innerHTML = message;
				//output.insertBefore(pre, output.firstChild);
			}
			window.addEventListener("load", init, false);
		</script>
		<style type="text/css">
			label { display: block; width: 150px; }
			input#submit { display: block; }
			#message {float: left; }
			#outputWrapper { float:left; margin-left: 30px; }
		</style>
	</head>
	<body>
		<div id="outputWrapper">

			<table id="results">
				<tbody id="output"></tbody>
			</table>
		</div>
	</body>
</html>
